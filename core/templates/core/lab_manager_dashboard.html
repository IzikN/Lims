{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">

  <!-- Notification Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Greeting -->
  <div class="alert alert-info d-flex align-items-center" role="alert">
    <i class="fas fa-user-md me-2"></i>
    <strong>Welcome back, {{ user.first_name|default:"Lab Manager" }}!</strong>
  </div>

  <!-- Quick Access Buttons -->
  <div class="d-flex flex-wrap gap-2 justify-content-end mb-3">
    <a href="{% url 'intake_dashboard' %}" class="btn btn-outline-primary">
      <i class="fas fa-warehouse me-1"></i> Intake Dashboard
    </a>
    <a href="{% url 'assign_tests' %}" class="btn btn-outline-danger">
      <i class="fas fa-tasks me-1"></i> Assign Tests
    </a>
    <a href="{% url 'reagent_list' %}" class="btn btn-outline-secondary">
      <i class="fas fa-flask me-1"></i> View Reagents
    </a>
    <a href="{% url 'equipment_list' %}" class="btn btn-outline-success">
      <i class="fas fa-cogs me-1"></i> View Equipment
    </a>
  </div>

  <!-- Filter/Search -->
  <form method="get" class="row g-2 mb-4">
    <div class="col-md-4">
      <input type="text" name="q" class="form-control" placeholder="Search by Sample ID or Client ID..." value="{{ request.GET.q }}">
    </div>
    <div class="col-md-3">
      <select name="status" class="form-select">
        <option value="">Filter by Status</option>
        <option value="assigned" {% if request.GET.status == 'assigned' %}selected{% endif %}>Assigned</option>
        <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>In Progress</option>
        <option value="submitted" {% if request.GET.status == 'submitted' %}selected{% endif %}>Submitted</option>
        <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">
        <i class="fas fa-search me-1"></i> Search
      </button>
    </div>
  </form>

  <!-- Summary Cards -->
  <div class="row text-center">
    <div class="col">
      <div class="card border-primary mb-3">
        <div class="card-header">Total Samples</div>
        <div class="card-body text-primary">
          <h5>{{ total_samples }}</h5>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card border-warning mb-3">
        <div class="card-header">Pending</div>
        <div class="card-body text-warning">
          <h5>{{ pending }}</h5>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card border-info mb-3">
        <div class="card-header">In Progress</div>
        <div class="card-body text-info">
          <h5>{{ in_progress }}</h5>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card border-success mb-3">
        <div class="card-header">Completed</div>
        <div class="card-body text-success">
          <h5>{{ completed }}</h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Section -->
  <h4 class="mt-4">Assignment Overview</h4>
  <canvas id="testChart" height="100"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('testChart').getContext('2d');
    const testChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Assigned', 'In Progress', 'Submitted', 'Completed'],
        datasets: [{
          label: 'Test Assignments',
          data: [{{ assigned }}, {{ in_progress }}, {{ submitted }}, {{ completed }}],
          backgroundColor: ['#6c757d', '#ffc107', '#0d6efd', '#198754']
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  </script>

  <!-- Test Types -->
  <h4 class="mt-5">Test Types</h4>
  <ul id="test-types-list" class="list-group">
    {% for key, val in test_types.items %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ key }}
        <span class="badge bg-primary rounded-pill">{{ val }}</span>
      </li>
    {% endfor %}
  </ul>

  <!-- Expiring Reagents -->
  <h4 class="mt-4">Expiring Reagents</h4>
  <ul id="reagents-list" class="list-group">
    {% for r in expiring_reagents %}
      <li class="list-group-item">{{ r.name }} ({{ r.expiry_date }})</li>
    {% empty %}
      <li class="list-group-item">All reagents are up-to-date</li>
    {% endfor %}
  </ul>

  <!-- Calibration Due -->
  <h4 class="mt-4">Equipment Calibration Due</h4>
  <ul id="calibration-list" class="list-group">
    {% for e in calibration_due %}
      <li class="list-group-item">{{ e.name }} – due {{ e.next_calibration_date }}</li>
    {% empty %}
      <li class="list-group-item">All equipment calibrated</li>
    {% endfor %}
  </ul>

</div>

<script>
  function fetchDashboardData() {
    fetch("{% url 'intake_dashboard' %}")
      .then(response => response.json())
      .then(data => {
        // Update counts
        document.querySelector('.card-body.text-primary h5').textContent = data.total_samples;
        document.querySelector('.card-body.text-warning h5').textContent = data.pending;
        document.querySelector('.card-body.text-info h5').textContent = data.in_progress;
        document.querySelector('.card-body.text-success h5').textContent = data.completed;

        // Update chart
        testChart.data.datasets[0].data = [
          data.assigned, data.in_progress, data.submitted, data.completed
        ];
        testChart.update();

        // Update test types list
        const testList = document.getElementById('test-types-list');
        if (testList) {
          testList.innerHTML = '';
          for (const [key, value] of Object.entries(data.test_types)) {
            testList.innerHTML += `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                ${key}
                <span class="badge bg-primary rounded-pill">${value}</span>
              </li>`;
          }
        }

        // Update expiring reagents
        const reagentList = document.getElementById('reagents-list');
        reagentList.innerHTML = data.expiring_reagents.length > 0 ?
          data.expiring_reagents.map(r => `<li class="list-group-item">${r.name} (${r.expiry_date})</li>`).join('') :
          '<li class="list-group-item">All reagents are up-to-date</li>';

        // Update calibration due
        const calibrationList = document.getElementById('calibration-list');
        calibrationList.innerHTML = data.calibration_due.length > 0 ?
          data.calibration_due.map(e => `<li class="list-group-item">${e.name} – due ${e.next_calibration_date}</li>`).join('') :
          '<li class="list-group-item">All equipment calibrated</li>';
      });
  }

  // Fetch every 60 seconds
  setInterval(fetchDashboardData, 60000);
</script>

{% endblock %}
